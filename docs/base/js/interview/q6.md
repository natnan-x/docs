<!--
 * @Author: NanNan
 * @Date: 2025-10-31 23:46:56
 * @LastEditTime: 2025-11-01 00:19:18
 * @Description:
-->

# JavaScript 脚本延迟加载方式有哪些？有什么区别？

## 一、核心结论

::: info JavaScript 延迟加载常见方式有：

```html
<!-- 方法1 -->
<script defer></script>
<!-- 方法2 -->
<script async></script>
<!-- 方法3: 动态创建<script></script> -->
<!-- 方法4: type="module" -->
```

区别主要体现在 执行时机、加载顺序 和 依赖处理。
:::

## 二、方式与区别详解

| 方式                | 加载行为             | 执行时机                                    | 是否按顺序执行      | 典型场景                     |
| :------------------ | :------------------- | :------------------------------------------ | :------------------ | :--------------------------- |
| **普通 script**     | 阻塞 HTML 解析       | 加载完成后立即执行                          | ✅ 按顺序           | 旧式同步脚本                 |
| **defer**           | 异步加载（并行下载） | DOM 构建完成后执行（`DOMContentLoaded` 前） | ✅ 保证顺序         | 多脚本依赖、页面初始化脚本   |
| **async**           | 异步加载             | 下载完立刻执行，**不等待 DOM**              | ❌ 无顺序           | 独立脚本（广告、统计）       |
| **动态创建 script** | JS 运行时插入        | 加载完立即执行（默认 async）                | ❌ 无顺序           | 条件加载、懒加载             |
| **type="module"**   | 异步加载模块文件     | 模块依赖解析完后执行                        | ✅ 模块依赖自动管理 | ES Module 项目（Vite、Vue3） |

## 三、详细示例

#### 1. 普通加载（阻塞）

```html
<script src="main.js"></script>
```

<b>浏览器会暂停 HTML 解析，直到脚本加载并执行完毕。</b>

#### 2. defer

```html
<script src="app.js" defer></script>
<script src="util.js" defer></script>
```

- 并行下载，不阻塞 DOM。
- DOM 解析完成后、DOMContentLoaded 前按顺序执行。
- 常用于主逻辑脚本或依赖 DOM 的代码。

#### 3. async

```html
<script src="ads.js" async></script>
<script src="analytics.js" async></script>
```

- 并行下载，不阻塞 DOM。
- 哪个脚本先加载完就先执行，不保证顺序。
- 用于独立脚本（广告统计类，不依赖其他文件）。

#### 4. 动态加载

```ts
const script = document.createElement('script');
script.src = '/lazy.js';
script.onload = () => console.log('加载完成');
document.body.appendChild(script);
```

- 默认异步加载，加载完立即执行。
- 可配合事件或条件（如用户操作）加载。

#### 5. 模块脚本

```html
<script type="module" src="main.js"></script>
```

- 自动延迟执行，等所有依赖加载完成后再执行。
- 相当于内置 defer 行为。
- 模块间依赖按 import 顺序保证。

## 四、面试高频加分点

1. `defer` 与 `async` 区别

- `defer` 保证顺序、在 DOM 解析后执行；
- `async` 不保证顺序、加载完立刻执行。

2. <b>模块脚本默认是 `defer` 行为</b>（但不能与 `defer` 一起用）。
3. <b>动态加载 `script` 的 `asyn`c 属性可手动设为 `false` 以强制顺序执行</b>：

```js
const s = document.createElement('script');
s.async = false;
s.src = '/file.js';
document.head.appendChild(s);
```

4. 性能优化策略：

- 首屏关键 JS 不应使用 `async`；
- 辅助类、第三方脚本适合 `async`；
- 应用主逻辑建议使用 `defer`；
- 模块化项目自动处理，无需手动设置。

## 五、口头答题模板（约 30 秒）

::: tip
“JS 延迟加载主要有四种方式：`defer`、`async`、动态创建 `script` 以及 `ES module`。`defer` 会并行加载，在 DOM 解析完后按顺序执行；`async` 会并行加载，哪个先完成先执行，不保证顺序；动态创建 `script` 默认异步，可按需加载；而模块脚本默认具有 `defer` 行为。实际开发中页面主逻辑脚本用 `defer`，独立脚本用 `async`，懒加载用动态创建。”
:::
