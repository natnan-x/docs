# Vue Router 导航解析全过程

> Vue Router 4（Vue3）完整导航解析流程，可直接复制到 VitePress 项目中使用。

## 一、导航的定义

**导航（Navigation）** 指路由从一个页面（`from`）切换到另一个页面（`to`）的全过程。

## 二、完整导航流程

```text
触发导航
   ↓
1. 全局前置守卫 beforeEach
   ↓
2. 路由独享守卫 beforeEnter
   ↓
3. 组件内 beforeRouteLeave
   ↓
4. 组件内 beforeRouteUpdate
   ↓
5. 组件内 beforeRouteEnter
   ↓
6. 异步组件加载
   ↓
7. 全局解析守卫 beforeResolve
   ↓
8. 导航确认（更新 currentRoute）
   ↓
9. 全局后置守卫 afterEach
   ↓
10. 组件挂载 / 激活 mounted / activated
```

## 三、源码角度理解

```ts
// 伪代码
router.push(location) {
  const to = resolve(location)
  const from = currentRoute.value

  runGuardQueue(beforeEachGuards, to, from)
  runGuardQueue(beforeEnterGuards, to, from)
  runGuardQueue(componentGuards, to, from)
  await resolveAsyncComponents(to)
  runGuardQueue(beforeResolveGuards, to, from)

  currentRoute.value = to
  afterEachGuards.forEach(g => g(to, from))
}
```

## 四、阶段解析

### 1. 触发导航

```ts
router.push('/home')
<router-link to="/about">关于</router-link>
```

### 2. 守卫阶段

| 阶段         | 钩子              | 注册位置 |
| ------------ | ----------------- | -------- |
| 全局前置守卫 | beforeEach        | 全局     |
| 路由独享守卫 | beforeEnter       | 路由配置 |
| 组件离开守卫 | beforeRouteLeave  | 组件内   |
| 组件更新守卫 | beforeRouteUpdate | 组件内   |
| 组件进入守卫 | beforeRouteEnter  | 组件内   |
| 全局解析守卫 | beforeResolve     | 全局     |
| 全局后置守卫 | afterEach         | 全局     |

### 3. 守卫执行顺序

1. beforeRouteLeave
2. beforeEach
3. beforeEnter
4. beforeRouteUpdate
5. beforeRouteEnter
6. beforeResolve
7. afterEach

### 4. 异步组件加载阶段

```ts
const routes = [
  { path: '/about', component: () => import('@/views/About.vue') },
];
```

### 5. 导航确认阶段

- 所有守卫执行完成且未调用 `next(false)`
- 更新 `currentRoute`
- 渲染组件

### 6. 后置守卫阶段

```ts
router.afterEach((to, from) => {
  console.log('已跳转到:', to.fullPath);
});
```

### 7. 错误与中断处理

| 触发方式       | 结果                |
| -------------- | ------------------- |
| next(false)    | 取消导航            |
| next('/login') | 重定向              |
| 抛出错误       | router.onError 捕获 |
| 未调用 next()  | 导航挂起            |

## 五、完整示例

```ts
router.beforeEach((to, from, next) => {
  console.log('1.beforeEach');
  if (to.meta.auth && !localStorage.getItem('token')) return next('/login');
  next();
});

router.beforeResolve((to, from, next) => {
  console.log('2.beforeResolve');
  next();
});

router.afterEach((to, from) => {
  console.log('3.afterEach');
});
```

输出顺序：

```
1.beforeEach
2.beforeResolve
3.afterEach
```

## 六、核心总结

> **从触发导航到确认渲染，Vue Router 按顺序执行守卫 → 加载组件 → 更新状态 → 渲染 → 执行后置钩子。**
